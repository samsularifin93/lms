<?php

//user.php

include '../database_connection.php';

include '../function.php';

if(!is_admin_login())
{
	header('location:../admin_login.php');
}

if(isset($_GET["action"], $_GET['code']) && $_GET["action"] == 'delete')
{
	$user_id = $_GET["code"];
	
	$query = "
	SELECT * FROM lms_user 
	WHERE user_id != '".$user_id."' 
	";

	$statement = $connect->prepare($query);

	$statement->execute();
	
	$status = "";
	
	if($statement->rowCount() > 0)
				{
					foreach($statement->fetchAll() as $row)
					{
						$status = $row['user_status'];
					}
				}
				
	if($status == "Enable"){
		$status = "Disable";
	}

	$data = array(
		':user_status'		=>	$status,
		':user_updated_on'	=>	get_date_time($connect),
		':user_id'			=>	$user_id
	);

	$query = "
	UPDATE lms_user 
    SET user_status = :user_status, 
    user_updated_on = :user_updated_on 
    WHERE user_id = :user_id
	";

	$statement = $connect->prepare($query);

	$statement->execute($data);

	header('location:user.php?msg='.strtolower($status).'');
}

$query = "
	SELECT * FROM lms_user 
    ORDER BY user_id DESC
";

$statement = $connect->prepare($query);

$statement->execute();

include '../header.php';

?>

<div class="container-fluid py-4" style="min-height: 700px;">
	<h1>User Management</h1>
	<ol class="breadcrumb mt-4 mb-4 bg-light p-2 border">
		<li class="breadcrumb-item"><a href="index.php">Dashboard</a></li>
        <li class="breadcrumb-item active">User Management</li>
    </ol>
    <?php 
 	
 	if(isset($_GET["msg"]))
 	{
 		if($_GET["msg"] == 'disable')
 		{
 			echo '<div class="alert alert-success alert-dismissible fade show" role="alert">Category Status Change to Disable <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
 		}

 		if($_GET["msg"] == 'enable')
 		{
 			echo '
 			<div class="alert alert-success alert-dismissible fade show" role="alert">Category Status Change to Enable <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>
 			';
 		}
 	}

    ?>
    <div class="card mb-4">
    	<div class="card-header">
    		<div class="row">
    			<div class="col col-md-6">
    				<i class="fas fa-table me-1"></i> User Management
    			</div>
    			<div class="col col-md-6" align="right">
    			</div>
    		</div>
    	</div>
    	<div class="card-body">
		<table id="eee" class="display" style="width:100%">
                        <thead>
                            <tr>
                                <th>Image</th>
								<th>User Unique ID</th>
								<th>User Name</th>
								<th>Email Address</th>
								<th>Password</th>
								<th>Contact No.</th>
								<th>Address</th>
								<th>Email Verified</th>
								<th>Status</th>
								<th>Created On</th>
								<th>Updated On</th>
								<th>Action</th>
                            </tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <th>Image</th>
								<th>User Unique ID</th>
								<th>User Name</th>
								<th>Email Address</th>
								<th>Password</th>
								<th>Contact No.</th>
								<th>Address</th>
								<th>Email Verified</th>
								<th>Status</th>
								<th>Created On</th>
								<th>Updated On</th>
								<th>Action</th>
                            </tr>
                        </tfoot>
                  </table>
    	</div>
    </div>
</div>

<script>

	function delete_data(code)
	{
		if(confirm("Are you sure you want to change status this User?"))
			{
				window.location.href = "user.php?action=delete&code="+code;
			}
	}

</script>

<?php 

include '../footer.php';

?>